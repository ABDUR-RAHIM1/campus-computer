"use client";
import { PostAction } from "@/actions/students/PostAction";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { jobProfilePostGet } from "@/constans";
import { globalContext } from "@/contextApi/ContextApi";
import { getStatusColor } from "@/utilities/getStatusColor";
import InputField from "@/utilities/InputField";
import SelectField from "@/utilities/SelectField";
import Spinner from "@/utilities/Spinner";
import React, { useContext, useEffect, useState } from "react";

const JobApplicationForm = () => {
    const { showToast, imgUrl, uploadResponse, uploader } = useContext(globalContext);
    const { status, message } = uploadResponse;

    const [loading, setLoading] = useState(false);
    const [formData, setFormData] = useState({
        isOtherPerson: false,
        nameEn: "",
        nameBn: "",
        fatherNameEn: "",
        fatherNameBn: "",
        motherNameEn: "",
        motherNameBn: "",
        dob: "",
        religion: "",
        gender: "",
        nidNumer: "",
        birthNumber: "",
        passportId: "",
        matarialStatus: "",
        mobileNumber: "",
        otherMobileNumber: "",
        email: "",
        presentAddress: "",
        permanentAddress: "",
        quota: "",
        cvLink: "",
        photo: "",
        signature: "",
        educations: [],
        documents: [],
        extra: "",
    });


    const [education, setEducation] = useState({
        eduType: "",
        categorie: "",
        instituteName: "",
        passingYear: "",
        board: "",
        roll: "",
        reg: "",
        gpa: "",
    })
    const [fileName, setFileName] = useState("")

    //  isOthersPerson Change
    const handlePersonChange = (e) => {
        const value = e.target.value;

        setFormData((prev) => ({
            ...prev,
            isOtherPerson: value === "yes" ? true : false
        }))

    }

    useEffect(() => {
        if (imgUrl && fileName) {
            setFormData((prev) => {
                // ржпржжрж┐ fileName "documents" рж╣ржпрж╝, рждрж╛рж╣рж▓рзЗ array рждрзЗ push ржХрж░рзЛ
                if (fileName === "documents") {
                    return {
                        ...prev,
                        documents: [...prev.documents, ...imgUrl] // ржЖржЧрзЗрж░ рж╕ржм ржпрзЛржЧ ржХрж░рзЗ ржирждрзБржи рж▓рж┐ржЩрзНржХ add
                    };
                } else {
                    // ржирж╛ рж╣рж▓рзЗ normal field ржЖржкржбрзЗржЯ ржХрж░рзЛ (photo ржмрж╛ signature)
                    return {
                        ...prev,
                        [fileName]: imgUrl[0]
                    };
                }
            });
        }
    }, [imgUrl, fileName]);


    //  add multiple Education in formState
    const handleAddNewEducation = () => {

        // рж╕ржм value ржЪрзЗржХ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
        for (let key in education) {
            if (!education[key]) {
                showToast(400, "ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ рж╕ржм рждржерзНржп ржкрзВрж░ржг ржХрж░рзБржи");
                return;
            }
        }
        setFormData((prev) => ({
            ...prev,
            educations: [...prev.educations, education]
        }));
        showToast(200, "рж╕ржлрж▓ржнрж╛ржмрзЗ ржпрзЛржЧ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ");
        setEducation({
            eduType: "",
            categorie: "",
            instituteName: "",
            passingYear: "",
            board: "",
            roll: "",
            reg: "",
            gpa: "",
        })
    };


    const handleChange = (e) => {
        const { type, name, value, files } = e.target;

        if (type === "file") {
            const file = files
            uploader(file);
            setFileName(name)
        } else {
            setFormData((prev) => ({ ...prev, [name]: value }));
        }
    };



    //  educations Change
    const handleEducationChange = (e) => {
        const { name, value } = e.target;

        setEducation({ ...education, [name]: value });
    }

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true)
        try {
            const payload = {
                method: "POST",
                endpoint: jobProfilePostGet,
                body: formData
            }
            const { status, data } = await PostAction(payload);
            showToast(status, data);


        } catch (error) {
            console.log("failed to create job Profile", error)
        } finally {
            setLoading(false)
        }
    }

    const otherPersonOptions = [
        { name: "ржЕржирзНржпрзЗрж░ ржЬржирзНржп", value: "yes" },
        { name: "ржирж┐ржЬрзЗрж░ ржЬржирзНржп", value: "no" },
    ]
    const religoionOptions = [
        { name: "ржЗрж╕рж▓рж╛ржо", value: "ржЗрж╕рж▓рж╛ржо" },
        { name: "рж╣рж┐ржирзНржжрзБ", value: "рж╣рж┐ржирзНржжрзБ" },
        { name: "ржЦрзНрж░рж┐рж╕рзНржЯрж╛ржи", value: "ржЦрзНрж░рж┐рж╕рзНржЯрж╛ржи" },
        { name: "ржЕржирзНржпрж╛ржирзНржп", value: "ржЕржирзНржпрж╛ржирзНржп" },
    ]

    const genderOptions = [
        { name: "ржкрзБрж░рзБрж╖", value: "ржкрзБрж░рзБрж╖" },
        { name: "ржорж╣рж┐рж▓рж╛", value: "ржорж╣рж┐рж▓рж╛" },
        { name: "ржЕржирзНржпрж╛ржирзНржп", value: "ржЕржирзНржпрж╛ржирзНржп" },
    ];

    const educationBoardOptions = [
        { name: "ржврж╛ржХрж╛ рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "ржврж╛ржХрж╛" },
        { name: "ржЪржЯрзНржЯржЧрзНрж░рж╛ржо рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "ржЪржЯрзНржЯржЧрзНрж░рж╛ржо" },
        { name: "рж░рж╛ржЬрж╢рж╛рж╣рзА рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "рж░рж╛ржЬрж╢рж╛рж╣рзА" },
        { name: "ржХрзБржорж┐рж▓рзНрж▓рж╛ рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "ржХрзБржорж┐рж▓рзНрж▓рж╛" },
        { name: "ржпрж╢рзЛрж░ рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "ржпрж╢рзЛрж░" },
        { name: "рж╕рж┐рж▓рзЗржЯ рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "рж╕рж┐рж▓рзЗржЯ" },
        { name: "ржмрж░рж┐рж╢рж╛рж▓ рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "ржмрж░рж┐рж╢рж╛рж▓" },
        { name: "ржжрж┐ржирж╛ржЬржкрзБрж░ рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "ржжрж┐ржирж╛ржЬржкрзБрж░" },
        { name: "ржоржпрж╝ржоржирж╕рж┐ржВрж╣ рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "ржоржпрж╝ржоржирж╕рж┐ржВрж╣" },
        { name: "ржорж╛ржжрзНрж░рж╛рж╕рж╛ рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "ржорж╛ржжрзНрж░рж╛рж╕рж╛" },
        { name: "ржХрж╛рж░рж┐ржЧрж░рж┐ рж╢рж┐ржХрзНрж╖рж╛ ржмрзЛрж░рзНржб", value: "ржХрж╛рж░рж┐ржЧрж░рж┐" },
    ];

    const isEducation = formData.educations?.length > 0;
    const isPhoto = Boolean(formData.photo);
    const isSignature = Boolean(formData.signature);

    return (
        <form
            onSubmit={handleSubmit}
            className="my-10 max-w-5xl mx-auto p-6 bg-white shadow rounded-lg">
            <div className=" text-center my-6">
                <h2 className="text-2xl font-bold mb-6 text-center text-gray-800">
                    ЁЯУЭ ржЬржм ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржлрж░рзНржо
                </h2>
                <p className=" text-red-500 text-sm font-semibold text-center animation-duration-initial ">
                    * ржжрзЗржУрзЯрж╛ ржкрзНрж░рждрж┐ржЯрж┐ ржлрж┐рж▓рзНржб ржкрзБрж░ржи ржХрж░рждрзЗ рж╣ржмрзЗред
                </p>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">

                <SelectField
                    name={"otherPerson"}
                    label={"ржХрж╛рж░ ржЬржирзНржп"}
                    onChange={handlePersonChange}
                    options={otherPersonOptions}
                    value={formData.isOtherPerson ? "yes" : "no"}
                    required
                />
                <InputField
                    label="ржЖржмрзЗржжржиржХрж╛рж░рзАрж░ ржирж╛ржо (ржЗржВрж░рзЗржЬрж┐)"
                    name="nameEn"
                    value={formData.nameEn}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ржЖржмрзЗржжржиржХрж╛рж░рзАрж░ ржирж╛ржо (ржмрж╛ржВрж▓рж╛рзЯ)"
                    name="nameBn"
                    value={formData.nameBn}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ржкрж┐рждрж╛рж░ ржирж╛ржо (ржЗржВрж░рзЗржЬрж┐)"
                    name="fatherNameBn"
                    value={formData.fatherNameBn}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ржкрж┐рждрж╛рж░ ржирж╛ржо (ржмрж╛ржВрж▓рж╛рзЯ)"
                    name="fatherNameEn"
                    value={formData.fatherNameEn}
                    onChange={handleChange}
                    required
                />

                <InputField
                    label="ржорж╛рждрж╛рж░ ржирж╛ржо (ржЗржВрж░рзЗржЬрж┐)"
                    name="motherNameEn"
                    value={formData.motherNameEn}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ржорж╛рждрж╛рж░ ржирж╛ржо (ржмрж╛ржВрж▓рж╛рзЯ)"
                    name="motherNameBn"
                    value={formData.motherNameBn}
                    onChange={handleChange}
                    required
                />

                <InputField
                    label="ЁЯОВ ржЬржирзНржо рждрж╛рж░рж┐ржЦ"
                    type="date"
                    name="dob"
                    value={formData.dob}
                    onChange={handleChange}
                    required
                />

                <SelectField
                    name={"religion"}
                    label={"тШк ржзрж░рзНржо"}
                    onChange={handleChange}
                    options={religoionOptions}
                    value={formData.religion}
                    required
                />
                <SelectField
                    name={"gender"}
                    label={"тЪз рж▓рж┐ржЩрзНржЧ"}
                    onChange={handleChange}
                    options={genderOptions}
                    value={formData.gender}
                    required
                />

                <InputField
                    label="ЁЯУЬ ржЬржирзНржо ржирж┐ржмржирзНржзржи ржирж╛ржорзНржмрж╛рж░"
                    name="birthNumber"
                    value={formData.birthNumber}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ЁЯЖФ ржПржи.ржЖржЗ.ржбрж┐ ржирж╛ржорзНржмрж╛рж░"
                    name="nidNumber"
                    value={formData.nidNumber}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ЁЯЫВ ржкрж╛рж╕ржкрзЛрж░рзНржЯ ржирж╛ржорж╛ржмрзНрж░"
                    name="passportId"
                    value={formData.passportId}
                    onChange={handleChange}
                />
                <InputField
                    label="ЁЯТН ржмрзИржмрж╛рж╣рж┐ржХ ржЕржмрж╕рзНржерж╛"
                    name="matarialStatus"
                    value={formData.matarialStatus}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ЁЯУЮ ржорзЛржмрж╛ржЗрж▓ ржирж╛ржорзНржмрж╛рж░"
                    name="mobileNumber"
                    value={formData.mobileNumber}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ЁЯУЮ ржЕрждрж┐рж░рж┐ржХрзНржд ржирж╛ржорзНржмрж╛рж░ "
                    name="otherMobileNumber"
                    value={formData.otherMobileNumber}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ЁЯУз ржЗржорзЗржЗрж▓"
                    name="email"
                    value={formData.email}
                    onChange={handleChange}
                    required
                />
                <InputField
                    label="ЁЯУз ржмрж░рзНрждржорж╛ржи ржарж┐ржХрж╛ржирж╛"
                    name="presentAddress"
                    value={formData.presentAddress}
                    onChange={handleChange}
                    placeholder={"ржЧрзНрж░рж╛ржо, ржкрзЛрж╕рзНржЯ, ржЙржкржЬрзЗрж▓рж╛, ржЬрзЗрж▓рж╛, ржкрзЛрж╕рзНржЯ ржХрзЛржб"}
                    required
                />
                <InputField
                    label="ЁЯУз рж╕рзНржерж╛рзЯрзА ржарж┐ржХрж╛ржирж╛"
                    name="permanentAddress"
                    value={formData.permanentAddress}
                    onChange={handleChange}
                    placeholder={"ржЧрзНрж░рж╛ржо, ржкрзЛрж╕рзНржЯ, ржЙржкржЬрзЗрж▓рж╛, ржЬрзЗрж▓рж╛, ржкрзЛрж╕рзНржЯ ржХрзЛржб"}
                    required
                />
                <InputField
                    label="ЁЯУз ржХрзЛржи ржХрзЛржарж╛ ржЖржЫрзЗ? "
                    name="quota"
                    value={formData.quota}
                    onChange={handleChange}
                    placeholder={"ржХрзЛржи ржХрзЛржарж╛ ржерж╛ржХрж▓рзЗ ржПржЦрж╛ржирзЗ рж▓рж┐ржЦрзБржи"}
                    required
                />


                <div className="sm:col-span-2 border rounded-sm p-2">
                    <h2 className=" font-medium my-3 text-center">рж╢рж┐ржХрзНрж╖рж╛ рждржерзНржп</h2>
                    <div className="grid grid-cols-2 gap-2">
                        <InputField
                            label="ЁЯУзржкрж░рж┐ржХрзНрж╖рж╛рж░ ржзрж░ржи"
                            placeholder={"ржкрж░рж┐ржХрзНрж╖рж╛рж░ ржзрж░ржи"}
                            name="eduType"
                            value={education.eduType}
                            onChange={handleEducationChange}
                            required={!isEducation}
                        />
                        <InputField
                            label="ЁЯУз ржмрж┐ржнрж╛ржЧ"
                            placeholder={"ржмрж┐ржнрж╛ржЧ"}
                            name="categorie"
                            value={education.categorie}
                            onChange={handleEducationChange}
                            required={!isEducation}
                        />
                        <InputField
                            label="ЁЯУз ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржирж╛ржо"
                            placeholder={"ржкрзНрж░рждрж┐рж╖рзНржарж╛ржирзЗрж░ ржирж╛ржо"}
                            name="instituteName"
                            value={education.instituteName}
                            onChange={handleEducationChange}
                            required={!isEducation}
                        />
                        <InputField
                            label="ЁЯУз ржкрж╛рж╢рзЗрж░ ржмржЫрж░"
                            placeholder={"ржкрж╛рж╢рзЗрж░ ржмржЫрж░"}
                            name="passingYear"
                            value={education.passingYear}
                            onChange={handleEducationChange}
                            required={!isEducation}
                        />

                        <SelectField
                            name={"board"}
                            label={"ЁЯУз ржмрзЛрж░рзНржб"}
                            onChange={handleEducationChange}
                            options={educationBoardOptions}
                            value={formData.board}
                            required={!isEducation}
                        />
                        <InputField
                            label="ЁЯУз рж░рзЛрж▓ ржирж╛ржорзНржмрж╛рж░"
                            placeholder={"рж░рзЛрж▓ ржирж╛ржорзНржмрж╛рж░"}
                            name="roll"
                            value={education.roll}
                            onChange={handleEducationChange}
                            required={!isEducation}
                        />
                        <InputField
                            label="ЁЯУз рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╕ржи ржирж╛ржорзНржмрж╛рж░"
                            placeholder={"рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╕ржи ржирж╛ржорзНржмрж╛рж░"}
                            name="reg"
                            value={education.reg}
                            onChange={handleEducationChange}
                            required={!isEducation}
                        />
                        <InputField
                            label="ЁЯУз ржЬрж┐ржкрж┐ржП"
                            placeholder={"Gpa, Cgpa, Division"}
                            name="gpa"
                            value={education.gpa}
                            onChange={handleEducationChange}
                            required={!isEducation}
                        />

                        <div className="sm:col-span-2">
                            <Button
                                type={"button"}
                                onClick={handleAddNewEducation}
                                variant={"outline"} className={" rounded-full px-6 hover:bg-gray-200 hover:text-blue-500 cursor-pointer bg-blue-500 text-white  transition-all"}>
                                ржпрзБржХрзНржд ржХрж░рзБржи
                            </Button>
                        </div>
                    </div>

                    {/* academic Informtion Table */}
                    {
                        isEducation &&
                        <div className="my-5">
                            <table className="w-full border border-gray-00 text-sm text-left rounded-lg overflow-hidden shadow-sm">
                                <thead className="bg-gray-100 text-gray-700 uppercase text-[12px]">
                                    <tr>
                                        <th className="px-4 py-2">Exam Name</th>
                                        <th className="px-4 py-2">Division/Subject</th>
                                        <th className="px-4 py-2">Institute Name</th>
                                        <th className="px-4 py-2">Passing Year</th>
                                        <th className="px-4 py-2">Board/University</th>
                                        <th className="px-4 py-2">Roll</th>
                                        <th className="px-4 py-2">Reg</th>
                                        <th className="px-4 py-2">GPA/CGPA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {formData.educations?.map((e, i) => (
                                        <tr
                                            key={i}
                                            className={`border-b hover:bg-gray-50 ${i % 2 === 0 ? "bg-white" : "bg-gray-50"
                                                }`}
                                        >
                                            <td className="px-4 py-2 font-medium text-gray-800">{e.eduType}</td>
                                            <td className="px-4 py-2">{e.categorie}</td>
                                            <td className="px-4 py-2">{e.instituteName}</td>
                                            <td className="px-4 py-2">{e.passingYear}</td>
                                            <td className="px-4 py-2">{e.board}</td>
                                            <td className="px-4 py-2">{e.roll}</td>
                                            <td className="px-4 py-2">{e.reg}</td>
                                            <td className="px-4 py-2">{e.gpa}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>

                        </div>
                    }

                </div>
                <div className="sm:col-span-2 space-y-1.5">

                    <div className="my-2">
                        <Label className={"mb-2"}>ржЕрждрж┐рж░рж┐ржХрзНржд рждржерзНржп</Label>
                        <Textarea
                            value={formData.extra}
                            onChange={handleChange}
                            placeholder={"ржЕрждрж┐рж░рж┐ржХрзНржд рждржерзНржп ржПржЦрж╛ржирзЗ рж▓рж┐ржЦрзБржи: Height , Chest etc"}
                        />
                    </div>
                    <br />

                    <div className="mt-2">
                        <InputField
                            name={"cvLink"}
                            label="рж╕рж┐ржнрж┐ рж▓рж┐ржВржХ"
                            value={formData.cvLink}
                            placeholder={"ржЧрзБржЧрж▓ ржбрзНрж░рж╛ржЗржн рж▓рж┐ржВржХ"}
                            onChange={handleChange}
                        />
                    </div>

                </div>


                <div className="sm:col-span-2 grid grid-cols-2 gap-2">
                    <div className="">
                        <InputField
                            type={"file"}
                            label="ЁЯУз ржлржЯрзЛ"
                            name="photo"
                            onChange={handleChange}
                            required
                        />
                        <p className={`${getStatusColor(status)} text-[12px]`}>
                            {
                                formData.photo && message
                            }
                        </p>
                    </div>

                    <div>
                        <InputField
                            type={"file"}
                            label="ЁЯУз рж╕рж┐ржЧржирзЗржЪрж╛рж░"
                            name="signature"
                            onChange={handleChange}
                            required
                        />
                        <p className={`${getStatusColor(status)} text-[12px]`}>
                            {
                                formData.signature && message
                            }
                        </p>
                    </div>

                </div>
                <div className="sm:col-span-2">
                    <InputField
                        type={"file"}
                        multiple
                        label="ЁЯУз ржбржХрзБржорзЗржирзНржЯрж╕"
                        name="documents"
                        onChange={handleChange}
                    />
                    <p className={`${getStatusColor(status)} text-[12px]`}>
                        {
                            formData.documents.length > 0 && message
                        }
                    </p>
                </div>
                <div className="sm:col-span-2">
                    <button
                        type="submit"
                        className="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium"
                    >
                        {
                            loading ? <Spinner /> : " тЬЕ ржкрзНрж░рзЛржлрж╛ржЗрж▓ рждрзИрж░рж┐ ржХрж░рзБржи"
                        }
                    </button>
                </div>
            </div>
        </form>
    );
};

export default JobApplicationForm;
